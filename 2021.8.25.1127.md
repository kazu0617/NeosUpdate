**2021.8.25.1127**
皆さん、こんにちは。今回は大きなアップデートをご紹介します。BEPUv1からBEPUv2への物理エンジンのアップグレードが完了しました! BEPUv2自体は、エンジンを完全に書き直し（名前と開発者だけは共通）、高度に最適化されています。また、Neosとエンジンの統合方法も完全に破棄され、書き直されました。

今回のビルドでは、パフォーマンスが大幅に改善され（特にコライダーの多いワールドやワールドの読み込み時において）、コライダーとのインタラクションが大幅に改善されました（ジッターが減り、高速でコライダーを通過することが減り、実際には滑らかなのにデコボコしたコライダーがなくなり、物理インタラクションが1フレーム遅れたり、ユーザーが乗り物から脱落したりすることがなくなりました）、さらにいくつかの新機能も追加されました。

例えば、ステップアップロジックがサポートされ、小さな障害物だけでなく、非常に大きな障害物も簡単に上ることができるようになりました。また、CharacterControllerは、どんな形状でも使用でき、回転をシミュレートしても、身長を尊重するようになりました。例えば、しゃがむと、障害物の下を通り抜けることができるようになりました。他にも新しいコライダの種類など、詳細は以下をご覧ください。

また、重要なこととして、このアップグレードは、さらなる最適化と、完全なリジッドボディのサポートのような新機能のための基礎となります（これはこのアップグレードには含まれていませんが、CharacterControllersでシンプルなリジッドボディのような動作を得ることはできます。将来的には、さらに多くの機能が追加される予定です。物理のロードマップをご覧ください。<https://github.com/Neos-Metaverse/NeosPublic/projects/19> 現在の制限を理解した上で、ぜひ楽しんでくださいね。:smile:

パフォーマンスの向上は、状況やワールドによって異なるでしょう。しかし、さらなる最適化が予定されていますので、今回はそのための重要な一歩となります。

また、初期のバグ取りに協力してくれたShifty | Quality Control LeadとQCチーム、そしてパブリックテストに参加してくれたDanger Tester'sにも感謝しています。Shadow Panther [RU/EN, UTC+3], Beaned, ohzee, Zyzyl, Alex from Alaska, Snooper, Pat cat, LucasRo7, Turk, Enverex, MattyK, Cyro, Modern, 1amNick, Hayden, Toxic_Cookie | NTC CEO, Elizabeth Dayax , Epsilion, epicEaston197, DrFrank, TheBasementNerd (she/her), Alex rainbowdashie, Sloppy McFloppy , Ian Corvid, Kulza, Tatsu Kimiero, Sylva, Gawdl3y, そしてレポートなしでテストしてくださった皆さん。

まだいくつかのバグなどがあるかもしれませんが、ゲームを壊すようなものではないことを願っています。随時修正していきますので、何か見つけたらGitHubに報告してください。

また、最初のうちは、既存のコンテンツに新しいアセットバリアントが生成されていないため、一部のワールドではロードが少し重くなるかもしれません。これらのワールドが読み込まれて訪問されるにつれて、徐々に改善されていくはずです。
**新機能**:
- BEPUv1の物理エンジンをBEPUv2に置き換えました（詳細はこちら：<https://github.com/bepu/bepuphysics2>） - GitHubやPatreonでの投票数が多い問題の一つであるため、優先順位をつけました（通常は1位と2位の間を移動します）。
BEPUv1との共通点は、名前と開発者だけです -- このバージョンの物理エンジンは完全に書き直されています。
-- このバージョンのエンジンは大幅に最適化されており、CPUとメモリの使用量を削減しています。
-- 独自のメモリ管理システムを使用し、ガベージコレクタによるスタッターやパフォーマンスの低下を低減しています。
-- コライダーの相互作用が大幅に改善され、多数の問題が修正されました（例：表面が滑らかであるにもかかわらず、一部のメッシュコライダーがでこぼこしていたり、コライダーを通過する回数を減らす必要があるなど）。
-- コリジョンの数値的な安定性が改善され、オフセットやコリダーが大きい場合や、非常に小さい場合のジッターが軽減されました。
-- 根底にあるインターフェイスが変更されたことにより、Neosとの統合がより効率的になり、Neosのシステムとの機能の適合性が向上しました。
-- Cylinder Colliderのハルスイープの問題を修正しました（報告者：H3BO3、GitHub Issue #1083）
-- BEPUv2に直接、高速なブーリアンのスイープをより効率的に再実装し、これらの操作のためのメモリの割り当てを大幅に削減しました。

- Neosとの物理エンジンの統合を再構築
-- 物理エンジンとNeosとの統合方法を全面的に見直し、効率性と柔軟性を向上させました。
-- BEPUv2は独立したパーツではなく、より緊密にNeosと統合されており、パフォーマンスのオーバーヘッドを減らし、問題の修正や新機能の追加を簡素化しています。
-- 既存のコライダとインタラクションはすべて、既存のコンテンツの機能を維持するために、機能的に同等のものが再実装されています。
-- メインワールドのインタラクションとHapticフィードバックに使用されるコライダは、完全に別のシミュレーションとなり、並列計算を行うことでパフォーマンスが向上しました。
-- 物理アップデートの一部が非同期で実行されるようになり、全体的なフレームレートが向上しました。
-- 移動/スケールされたトランスフォームは、物理コンポーネントとその他のコンポーネントで別々にトラッキングされるようになりました。
-- これにより、現在見つかっている直近のヒット以外のオブジェクトに対するレイキャストテストをスキップし、一時的な結果を保持するためのリストの割り当てを完全に回避することができます。
-- ネイティブにサポートされたオペレーションとして、SweepOne および BooleanSweepOne を実装しました。
-- より一貫した動作を実現するために、エンジンの更新ステージを拡張し、並び替えを行いました。
--- これ（他の変更との組み合わせ）により、ホストではないユーザーが高速で動くオブジェクトの下で親になったときに物理が1フレーム遅れてしまうのを修正しました（報告者：Hayden, H3BO3, GitHub Issues #2248）。
-- コライダータイプが適切にスリープし、お互いを起こさないようにしました。これにより、コライダーやトリガーが多い世界でのCPU使用率が大幅に減少しました（例：Minecraftのインポートマップ）。
-- 重要：**BEPUv2はCone Collidersをネイティブにサポートしていません。Neosは凸型のハルを使って透過的にエミュレートしますが、結果的に効率が悪くなります。可能であれば、他のプリミティブな形状を使用することをお勧めします。動作はします。**
-- ConeCollidersのオフセットが間違っていたのを修正しました（報告者：chemicalcrux、GitHub Issue #1471）。
-- Convex Sweep のゼロ距離でのヒットが適切に処理されるようになった(これはレーザーがインスペクタの端でカールバックしたり、他のケースでランダムに飛び跳ねたりするのを修正するもので、H3BO3, GitHub Issue #492 により報告された)
-- 現在の形状を使用してコリダーコンポーネントを内部的に掃引する機能を追加しました。
-- MeshCollider と ConvexHull の加速構造がプロシージャルメッシュ用にダブルバッファされるようになり、一部のメッシュインタラクションがランダムにちらつく現象が修正されました。
-- より効率的なイベントシステムを実装し、コリジョンが発生しているときのメモリの割り当てとCPUのオーバーヘッドを大幅に削減しました。コリジョンが発生していないときには計算を行わない場合もあります。
-- 物理システムのより安定したステッピングを実現するためにタイムステッピングを再実装し、ジッターやコリダーの通過を引き起こす不安定な問題を軽減しました。
-- MeshCollidersに、平均的な三角形の密度に基づいて投機的なマージンを計算するヒューリスティックを実装し、相互作用を改善する一方で、密度の高いメッシュでのパフォーマンスの問題を回避しました。
-- 全体的なパフォーマンスと動作が良好になるように統合を微調整しました。

- CharacterControllerはただのカプセルのみ使えていたのが、任意の凸型のコライダを使用できるようになりました。
-- 同じスロットに配置された、 "CharacterController" タイプに設定された最初のコライダが使用されます。
-- 既存のCharacterControllerインスタンスは自動的にアップグレードされます。
-- これにより、オフセットのカスタマイズや形状の変更がリアルタイムにできるようになりました（以前、Robyn (QueenHidi), GitHub Issue #1843 からのリクエスト）。
-- MassプロパティはColliderにローカライズされましたが、現在はダイナミックボディ（CharacterControllerなど）にのみ適用されます。

- CharacterControllerにステップアップロジックを実装し、小さな障害物と高い障害物の両方を歩くことができるようになりました（以前、Enverexや他の多くの方から要望がありました）。
-- 技術的にはステップアップの高さは無制限ですが、それ以上の値を設定すると奇妙な動作になるため、常識的な値（おそらく最大でも100cm）を推奨します。
-- 障害物に衝突した場合、現在の形状を上方にオフセットして進行方向に掃引し、前方の空間が空いているかどうかを確認します。障害物がない場合、キャラクターは障害物をステップアップします（それはサポートとみなされます）。
-- `StepUpHeight` は、キャラクターコントローラがステップアップできる最大の高さを決定します。
-- `StepUpCheckDistance` は、他の障害物がないかどうかを判断するために、形状を移動方向に振り切る距離を決定します。
- `MaximumTractionSlope` と `MaximumSupportSlope` がCharacterControllerでサポートされ、これにより完全に垂直（90度）な壁であったとしても、これらのパラメータを調整することでCharacterControllerが壁を登るように設定できるようになりました
- CharacterController に `Debug Visuals` プロパティを追加しました。
-- Non-null の値は、指定した秒数の間ビジュアルを表示します。
-- これは、環境とインタラクトする際に発生する可能性のあるすべてのコンタクトを表示するもので、デバッグ目的に役立ちます。
これはデバッグに役立ちます -- なお、これを使用するとパフォーマンスとネットワークが非常に重くなります。デバッグ目的でのみ使用してください

- ユーザーの身長に基づいてカプセルのコライダーの高さを管理する `SingleShapeCharacterControllerManager` を実装し、キャラクターの形状がプレイヤーの身長を尊重するようにした（以前にEnverex, Abysmal, Shadow Panther [RU/EN, UTC+3], Raith (CytraX) | Programmer, Turkなどから要望があった）。
-- これにより、しゃがむと障害物の下を通ることができるようになりましたが、若干幅が広くなりました（これは設定可能です）。
-- キャラクターコントローラーのデフォルトの半径を少し大きくして、より良いインタラクションを実現しました。
-- Desktop HeadSimulator は、しゃがむときに障害物を認識するようになり、 CharacterCollider の下にいる場合はしゃがみを解除してもプレイヤーが立ち上がらないようになりました。

- CharacterControllerに `KllVerticalVelocityAfterStepUp` を追加（Shadow Panther [RU/EN, UTC+3]の報告による。
-- これは、垂直方向の速度を現在の平面方向の速度に変換し、プレイヤーを下に押し戻すことで、スロープや階段から走り降りるときにプレイヤーが空気を吸いすぎる(駆け降りるとたまに浮いちゃってた現象のことだと思います)のを防ぎます。
-- 階段で非常に揺れやすくなるため、デフォルトではオフになっています。
- CharacterControllerの回転シミュレーションを解除する機能を追加
-- **重要：この機能により、キャラクターコントローラーを単純なリジッドボディとして使用することができますが、これは適切なリジッドボディのサポートではありません。次のような問題が発生します。**
--- CPUとネットワークの使用率が高い
--- CharacterController には余分なものが付いていて、一人のユーザをシミュレートしているので、他のユーザがインタラクションするとランダムにテレポートしてしまいます。
--- コントロールの欠如 - 常に摩擦がなく、制約を作ってより複雑なものを作ることができません。
-- これは主に、よりリアルなZero-G運動などの用途を想定していますが、限界を理解しているのであれば、それを楽しんでください。
-- Rigidbodyシミュレーションについての詳細はこちら: <https://github.com/Neos-Metaverse/NeosPublic/issues/22>

- MeshCollider に `Sidedness` を追加
-- これにより、効率が向上し、インタラクションが改善されます（例えば、ジオメトリの後ろや地面の一部に挟まれることなく、代わりに押し出されます）。
-- ほとんどの場合、CharacterCollider MeshColliderを自動的に`Front Sided`に変換し、インタラクションを改善するヒューリスティック機能を追加しました。
--- 同じSlotに両面のマテリアルがある場合、両面のままになります。
--- コライダーに負のスケーリングがある場合、同様にデュアルサイドが維持されます。

- StaticTriggerとHapticStaticTriggerのコライダタイプを追加しました。
-- トリガーがワールド内で動かないことが確実に分かっている場合（直接または親を通して）、これらのタイプを使用することをお勧めします。
- StaticTriggerAutoとHapticStaticTriggerAutoを追加しました。
-- これらは上記のバージョンと同じ動作をしますが、動かされるたびにトラッキングを行います。数フレーム動かされただけで、自動的にトリガー/ハプティックトリガーに切り替わります。
-- TriggerやHapticTriggerを使用している古いコンテンツは、自動的にこれらのタイプに変換されるので、手動で更新しなくても静的トリガーの恩恵を受けることができます。
-- 新しいコンテンツでは、これらの使用は推奨されません。トラッキングのオーバーヘッドを避けるために、コンテンツの使用パターンに応じてトリガーとスタティックトリガーのどちらかを選択してください。

- ApplyCharacterImpulse と ApplyCharacterForce がデフォルトで CharacterController の質量を考慮するようになりました。
-- 新しい IgnoreMass 入力に true を渡すことで無効にできます。
-- 古いノードは、後方互換性のためにプラグインされたTrue値に自動的にアップグレードされます。

- TriangleColliderの追加
-- 三角形は片面なので、正面からしか衝突しないことに注意してください。エッジとの衝突は現在のところランダムです - エッジを通過することもあれば、衝突することもあります（詳しくはこちらをご覧ください。 <https://github.com/bepu/bepuphysics2/issues/134#issuecomment-904201884>)

**細かい新機能**:
- ワールドにリンクしているneosrec:///のURLをクリップボードから貼り付けると、そのワールドが読み込まれるようになりました。
- `TriangleDiagnosticMesh` を追加しました。これは、与えられたインデックスを持つ単一の三角形を頂点カラーリングし、それを頂点法線に沿って変位させることができます。
-- これは主にゲーム内のジオメトリの問題を診断するためのものですが、単一のトライアングルが必要な場合には便利です。
- ハイライトで位置のトラッキングを回避する機能を追加(現在は内部的な機能のみ)
- 「新規作成」→「3Dモデル」ダイアログに「三角形」を追加
**最適化**:
- 静的アセットのメッシュコライダー加速構造とコンベックスハルコライダーは、アセットバリアントシステムを使用して計算されるようになりました。
-- これにより、ワールドやアイテムをロードする際のメモリとCPUの使用量が大幅に削減されます。なぜなら、以前はこれらは常にオンザフライで計算されていましたが、現在は事前に計算され、キャッシュされているからです。
-- 事前に生成されたコピーをロードするのは、ゼロから計算するのに比べて数分の一の時間で済むため、これによりロードプロセスが高速化され、コライダーをより早く利用できるようになります
- RaycastAllの多くの一般的な使用方法をRaycastOneに置き換え、パフォーマンスの向上とメモリ割り当ての削減を図りました。これにはパーティクルシステムのコリジョンも含まれますが、これらは非常にレイキャストヘビーであり、RaycastOneとRaycaster logixノードも含まれます。
-- これにより、動作に変化はなく、CPU時間とメモリの割り当てが若干減るだけです。
- 一般的に使用されている凸状のスイープとオーバーラップを、必要に応じて(Bool)SweepOneとOverlapOneに置き換え、これらの動作で若干のパフォーマンスの向上を図りました。
-- 同様に、動作は同じですが、CPUとメモリの使用量を減らすことができます。
-- Interaction Laser Stickingやスポーンエリアのプレイヤーチェックにこれらのチェックが使用されるようになりました。
- インターアクション・レーザーに三角形の密度のヒューリスティックを追加し、掃引のサイズに対して密度が高すぎるメッシュ・コライダに対する凸状の掃引を防ぎ、レーザーが密度の高いメッシュ・コライダに固着しようとするときにパフォーマンスの問題が発生するようになりました。
-- その代わりに、レーザーはオブジェクトの周りをスライドするのではなく、最後の既知のポイントに固執します。
-- 密着時のスライディング動作が必要な場合は、オブジェクトにプリミティブ・コライダ（理想）、コンベックスハル・コライダ、最悪の場合は大きな三角形で最適化されたメッシュ・コライダを設定してください。
-- メタデータがまだ計算されていない場合に、密集したメッシュにくっつかないようにするためのヒューリスティックな手法が追加されました。
- 凸型掃引の収束と反復パラメータを内部的に設定する機能を追加し、様々な掃引クエリで精度と性能をトレードオフできるようになりました。
-- 凸状の掃引を行う際の精度と性能のトレードオフを可能にしました。
-- Boolean sweep/overlapsでは、反復が必要ないため、完全に無効化されました。
- System.Numerics.VectorsのILパッチャーを実装し、Unityに組み込まれたMonoランタイム用に最適化することで、多数のメモリ割り当てを削除し、Unity内でのパフォーマンスを大幅に向上させました。
-- このライブラリは、BEPUv2だけでなく、System.Text.Json（クラウドAPIとの通信に使用）などの他のライブラリでも使用されています。

- トランスフォームの変更のトラッキングが、スケールの変更と位置/回転の変更に分割されるようになりました。
-- これにより、スケールの変更（まれ）によってのみ発生する計算が、階層の移動／回転（頻繁）によっても発生するため、無駄な計算が減少します。
- バックグラウンドワーカーの最適化により、ストールや無駄なサイクルを削減
- アセットバリアントシステムは、計算をスケジューリングしてから実際に計算するまでに十分な時間が経過した場合、ローカルで計算する前にクラウドで世代バリアントを再確認するようになりました。
- アセットリファレンスがNULLに設定された場合、以前のターゲットアセットを解放し、アンロードできるようになりました。
- ローカルのアセットメタデータ計算のスケジューリングを見直し、無制限にタスクを開始するのではなく、限られたコアでのみ実行するようにしたため、システムリソースの使用量が多くなりました（基本的に、PCへの負担が少なくなりました。この問題はHaydenが以前報告していました）。
-- 利用可能なCPUコアの4分の1までしか実行されないようにしました。
-- 計算タスクは、スケジューリングから実際の計算までに十分な時間があれば、その間にクラウドのメタデータが計算されているかどうかを確認し、不要なローカル計算をスキップします。
-- これは、メッシュアセットの数が多いため、Minecraftのインポートマップの新しいリージョンに入るときに特に顕著になりますが、Neosの全体的なスタッタリングの量を減らすのに役立つはずです。
- アセットのロードプロセスを調整し、専用のバックグラウンドワーカーでロックの多い部分を実行しないようにしましたが、データの実際のロードは専用のバックグラウンドスレッドで行われるようにしました。
-- これにより、タスクスケジューラーが大量のスレッドを生成することで、大量のアセットをロードする際のスタッタリングやシステムの過負荷が改善されるはずです（報告: Hayden）。
- 重い処理が通常のパフォーマンスに大きな影響を与えるのを避けるため、ローカルのアセットバリアント生成をシングルコアに制限しました
- アセットバリアント生成が専用のバックグラウンドワーカースレッドで実行されないことがあり、重大なスタッターやフリーズの原因となることがありました。

- Headlessがオーディオイベントを、毎フレームではなく実際のレートで実行するようになりました。
-- これにより、特定のケース、特に高いティックレートでのCPU使用率を削減することができます。
- Headless はユーザースペースにアバタープロキシオブジェクトをセットアップしなくなりました。
- CharacterTeleporterが破壊された後もオブジェクトへの参照を保持することがあり、GCが大きなメモリを解放するのを妨げる可能性があったのを修正しました。
**調整**:
- 非推奨のSphereDetector LogiXノードを削除しました。
- クラウドAPIとの通信時のシリアライズエラーに診断機能を追加
- Activeに設定されているMeshColliderを自動的にStaticに切り替えました（以前はフィルタリングされていたため）。
-- ActiveコライダをMeshColliderで使用することは、パフォーマンスに大きな悪影響を与えるため、代わりにプリミティブ・コライダを使用してください。
-- 既存のコンテンツが壊れるようであれば、ご連絡ください、調整できるかどうか確認します。
- カリングシステムのための新規インポートに `StaticTrigger` を使用するよう Minecraft インポーターを更新しました (Enverex の報告に基づく)
- CharacterForceField/Parenter/Teleporter は、現在キネマティック（シミュレートされていない）なキャラクターコントローラには作用しなくなりました。
-- これにより、ビークルや類似のセットアップとの干渉が修正され、ビークルのキャラクターコントローラにのみアクションが適用されるようになりました(MattyK氏の報告)
- 設定のSmoothTurnSpeedとNoclipSpeedの最大値を増やしました。
- ConvexHullコライダーは、参照されるメッシュが更新されたときに自分自身も更新されるようになり、変更された形状を尊重するようになりました。
-- 注意：頻繁に変更されるメッシュ（プロシージャルメッシュなど）をコライダーとして使用することは、コライダーの再構築に比較的時間がかかるため、非常にお勧めできません。
- `AxisRotationAligner` が、外部ソースから書き込まれたときに即座に回転を更新するようになり、これにより1フレームのジッターを防ぐようになりました。
- コリジョンリスナーコンポーネント(Character Parenter/ForceField/Teleporter/Triggerなど)にTriggersOnlyを追加し、トリガー以外からのイベントをフィルタリングするようになりました(デフォルトではtrue)
-- 既存のコンテンツに対しては、自動アップグレードのヒューリスティックな処理が行われます。これにより、古いコンテンツの機能を維持しつつ、トリガーとスタティックコライダーの両方が存在する場合のグリッチな動作を修正します。
- Shadow Pantherさんによりロシア語の翻訳を追加しました。
- @MirPASEC さんにより韓国語の翻訳を追加しました。
- rampa_3さんによりチェコ語の翻訳を追加しました。
- @Aesc さんにより日本語の翻訳を追加しました。

**バグ修正**:
- インストールされたロコモーションモジュールがランダムなオフセットを持たなくなりました（インストールロコモーションについては現在一部変な挙動があるため追加で修正中です）。
- LogiXのコリジョンイベントが登録解除されないことがあるのを修正
- キャラクターのEventTrigger/ForceField/Parenter/Teleporterで、 StaticColider からのイベントがトリガーと同じスロットに存在する場合、二重にトリガーされてしまうのを修正。
- 急激な動きをすることでCharacterParenterがユーザーを落としてしまう問題を修正 (報告: Shifty | Quality Control Lead, H3BO3, Enverex, Beaned その他の方々, GitHub Issues #1327)
- LogiXのTipで配線を削除したときに、初期点とTipとの距離が0になったときの例外に対するガードを追加しました。
- CDFTを与えたときにCDFTトークンの引き出し通知を送信する問題を修正しました (報告: Karel | CEO)
- 無効なボーン（例：NaN bindposes）を持つメッシュが、メッシュメタデータの計算時に例外が発生する問題を修正
- VHACD、NewWorld Dialogなどでヘルプボタンが機能しないのを修正。
- ドライブルートが変な角度で装備されているアイテムやツールを修正しました（報告者：Modern、Shadow Panther [RU/EN, UTC+3]）。
-- 注意：ツールチップのルートの位置、回転、スケールを駆動することは推奨されていません！むしろその下の子に対してドライブすることをお勧めします。
- ターゲットバウンスが有効でない場合、 `BoundingBoxDriver` の位置が無限大付近に移動してしまう問題を修正しました。
- TextGizmoの編集アイコンが、テキストが完全に初期化される前に無限大近くまで移動してしまう問題を修正
- 位置、回転、スケールが駆動されるとキャッシュされたトランスフォームパラメータが同期しなくなり、再ペアリングされてしまう問題を修正 (報告: Shadow Panther [RU/ EN, UTC+3])
-- これにより、コライダやバウンディングボックスなどが遅延し、再ペアレントされる前の古い位置に留まってしまうことがありました。