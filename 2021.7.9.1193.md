**2021.7.9.1193**
皆さん、こんにちは。
新しいビルドをご紹介します。これは主にクラウドの変更で、応答性を大幅に改善し、新しいサービスをより強固なものにするためのものです SignalRへの切り替えは、私が期待していたよりも少し失敗してしまいましたが（不便な点があったにもかかわらず、ご理解いただきありがとうございました^^;）、長い目で見れば本当に価値のあるものであり、ユーザー数が増えればより良いスケールになるはずです。

特に、メッセージ履歴のロードに時間がかかる原因がわかりました。いくつかのケースでは、データベースのクエリが非常に最適ではなく、1回の取得に数秒のデータベース時間を要していました。例えば、テストに使用したメッセージ履歴のロードには、約14,000 RU（Request Units、データベースのスループット単位に相当）が消費されていました。クエリを単純化するために追加のフィールドを追加し、複合インデックスを追加した後（既存のメッセージをすべて再インデックス化しなければならなかったので、昨日はそう感じたことでしょう！）、現在はわずか8RUしかかかりません。

その結果、メッセージ履歴は全体的に超高速で読み込まれるようになり、クラウドに負荷をかけて他のものが遅くなるのを防ぐことができるようになりました。それでもまだ問題があるようでしたら、ご連絡ください。

他にもたくさんの改善点があります。クラウドにも別の問題が発生しました。Redisサーバーの再起動により、速度制限ライブラリが再初期化されず、すべてが壊れてしまいました。これは現在修正されています。このシステムは、Redisが一時的に失敗した場合のフォールバックも備えており、失敗し続けた場合は自動的に再起動します。

とにかく、今はとてもスムーズに動いていることを願っています。また何か問題が発生しないかどうか監視してみます。まだまだ最適化しなければならない点はありますが（例：ワールド検索／ブラウジング、コンタクトの初期ロード、その他多数）、これはかなり重要な前進となるはずです。

また、今回のビルドは、ほとんどの変更がクラウド上で行われたため、前回のビルドと互換性があります（ただし、今回のビルドにも素晴らしいものがあるはずです）。
**微調整**
- データベース内のメッセージに最適化されたインデックス値を追加し、メッセージ履歴クエリを最適化することで、メッセージ履歴を取得する際に必要なデータベースのスループットを大幅に（桁違いに）削減しました。
-- メッセージ履歴の読み込みが大幅に速くなり、クラウド・バックエンドの負荷が軽減されました。
-- また、リクエストのタイミングがずれたためにメッセージ履歴がまったくロードされないケースも修正されます。
-- さらに、メッセージ履歴の読み込みがデータベースに異常な負荷をかけなくなったことで、クラウド全体の応答性が向上しました。
-- 既存のメッセージはすべて処理され、インデックスが再作成されました（これは昨日のスローダウンの主な要因の1つでした）。もし、メッセージが読み込まれなかったり、消えてしまったりした場合には、ぜひご連絡ください。
- クラウドAPIサーバーのヘルスチェックを改善し、CosmosDBやRedisに問題が発生した場合にサーバーが再起動されるようにしました。
-- クラウドAPIサーバーのヘルスチェックを改善しました。
- レコードを取得する際のデータベースクエリのバッチサイズを調整し、特定の操作（例：レコード使用レポートの生成）がデータベースに大きな負荷をかけ、クラウドの速度低下を引き起こすことを防止
- レコード使用状況レポート/JSONがパイプライン化され、レートが制限されるようになり、クラウドサービスに支障をきたす可能性を回避し、堅牢性を向上させました。
-- コマンドは10分に1回、1日最大8回までしか実行できません。これは変更される可能性がありますが、一般的にはあまり頻繁に実行することはお勧めできません。
-- 複数のリクエストがあった場合、リクエストは順番に処理され、一度に多くの高価なタスクを実行してデータベースに負荷をかけることを防ぎます。生成が終了すると通知されます。
- クラウドメッセージングシステムが、メッセージの送信状態をローカルに追跡するようになりました。
-- これにより、メッセージの履歴が更新されたときに、メッセージが送信された、または送信に失敗したと適切に表示されます。
- Redisの接続問題が発生した際に、プロセス内でレート制限を行うフォールバック機能を追加しました。
-- これにより、Redisサーバへの接続が途切れた場合のクラウドサービスの堅牢性が向上します。
- セッションリストにVBLFCバッジが表示されるようになりました(提案: Deltaさん, Kulzaさん)
- 軸移動のデッドゾーンのアルゴリズムを、個々の軸ではなく大きさに基づいて変更するようになり、斜め方向の動作が改善されました(報告: H3BO3さん)
- 履歴がロードされる前にユーザーにメッセージを送信した場合、新しく送信されたメッセージが消えないようにしました。

- Shadow Pantherによるロシア語の追加を統合
- @Aesc さんによる日本語の追加と微調整を統合
- @Holy_Waterさんによる韓国語の追加を統合
- @Holy_Waterさんによる中国語の追加と調整の統合
- rampa_3 によるチェコ語の追加を統合
- InnocentThiefさんによるドイツ語の追加と微調整を統合

**セキュリティ**
- ホストユーザーのIDに難読化処理を追加（runtime氏の報告による)。
**バグ修正**
- FireflySoft.RateLimitライブラリのバグを修正しました。Redisサーバが予期せず再起動された場合、Lua Redisスクリプトがクリアされるため、すべてのレートリミットチェックが失敗する原因となっていました。
-- これが昨日のクラウド問題の主な原因でした。
-- 修正版のプルリクエストはこちらからどうぞ： https://github.com/bosima/FireflySoft.RateLimit/pull/7
- フルメッセージの取得率の制限が正しく機能せず、フルメッセージの取得が頻繁に行われてしまう問題を修正しました。
- SignalRのデバッグメッセージが間違っていたのを修正 (報告: Bitmanさん (Neos.js Developer))
- アクセスキーのあるパスでレコードをフェッチする際の誤ったURLを修正(報告: Bitmanさん (Neos.js Developer))
- スムーズターンの排他モードで、移動中の回転を防ぐだけでなく、すでに回転しているときにも移動を防ぐようになった(報告: H3BO3さん / Kaptain Krunchさん)

**2021.7.9.1297**
一部のメッセージが重複して表示されることがある問題に気付いたための追加パッチです。

以前のバージョンとの互換性がありますので、すぐにアップデートする必要はありません。

**バグフィックス**
- セッション中に初めてメッセージをクリックする前に新しいメッセージを送ってきたユーザーの履歴を読み込むと、メッセージが重複してしまう問題を修正しました（報告: Mysticporo）。

**クラウドアップデート**
VBLFCに参加された方々から寄せられた評価をもとに、いくつかの（緊急的な）最適化をクラウドに反映させました。

あなたの側で何かをアップデートする必要はありません。現在、すべての人にライブ配信されていますが、連絡先のステータス（どの世界にいるのか、オンライン/離席中なのかなど）が更新されないという奇妙な現象に気づいたら、私たちに知らせてください。なお、更新に数秒かかることは通常のことです。

**最適化**
- 不要なセッション取得をスキップし、インメモリーキャッシュを追加することで、クラウド上でのステータス更新を最適化しました。
- 重いインメモリーキャッシングを使用して、クラウドからのユーザーのステータスアップデートの取得を最適化しました。
- オフラインのステータスの問い合わせをスキップすることで、連絡先リストの初期読み込みを最適化
